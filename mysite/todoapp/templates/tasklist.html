{% extends "base.html" %}
{% load static %}
{% block title %}Task List{% endblock %}
{% block TaskListCSS %} <link href="{% static 'css/todo.css' %}" rel="stylesheet" /> {% endblock %}



{% block "Content" %}

<section class="vh-100">
  <div class="container py-5 h-50">
    <div class="row d-flex justify-content-center align-items-center h-50">
      <div class="col">
        <div class="card fixed-header" id="list1" style="border-radius: .75rem; background-color: #eff1f2;">
          <div class="card-body py-4 px-4 px-md-5">
            <p class="h1 text-center mt-3 mb-4 pb-3 text-primary">
              <i class="fas fa-check-square me-1"></i>
              <u>My Todo-s</u>
            </p>

            <div class="pb-2">
              <div class="card">
                <div class="card-body">
                  <form id="TodoItemForm" method="post" action="{% url 'add_todo' %}">
                    {% csrf_token %}
                    <div class="d-flex flex-row align-items-center">
                      <input type="text" name="task" class="form-control form-control-lg" id="exampleFormControlInput1" placeholder="Add new...">
                      <a href="#!" data-mdb-toggle="tooltip" title="Set due date"><i class="fas fa-calendar-alt fa-lg me-3"></i></a>
                      <div>
                        <button type="button" id="addTaskButton" class="btn btn-primary">Add</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>


            <hr class="my-4">

            <div class="d-flex justify-content-end align-items-center mb-4 pt-2 pb-3">
              <p class="small mb-0 me-2 text-muted">Filter</p>
              <select class="select">
                <option value="" selected disabled>Select status</option>
                  {% for status_code, status_label in status_choices %}
                    <option value="{{ status_code }}">{{ status_label }}</option>
                  {% endfor %}
              </select>
              <p class="small mb-0 ms-4 me-2 text-muted">Sort</p>
              <select class="select">
                <option value="1">Added date</option>
                <option value="2">Due date</option>
              </select>
              <a href="#!" style="color: #23af89;" data-mdb-toggle="tooltip" title="Ascending"><i
                  class="fas fa-sort-amount-down-alt ms-2"></i></a>
            </div>

              {% for item in task %}
            <ul id="taskList" class="list-group list-group-horizontal rounded-0 mb-2">
              <li
                class="list-group-item d-flex align-items-center ps-0 pe-3 py-1 rounded-0 border-0 bg-transparent">
                <div class="form-check">
                  <input class="form-check-input me-0" type="checkbox" value=""
                    aria-label="..." />
                </div>
              </li>
              <li
                class="list-group-item px-3 py-1 d-flex align-items-center flex-grow-1 border-0 bg-transparent">
                <p class="lead fw-normal mb-0 bg-light w-100 ms-n2 ps-2 py-1 rounded">{{item.task}}</p>
              </li>
                <li class="list-group-item px-3 py-1 d-flex align-items-center border-0 bg-transparent">
                <div
                  class="py-2 px-3 me-2 border border-warning rounded-3 d-flex align-items-center bg-light">
                  <p class="small mb-0">
                    <a href="#!" data-mdb-toggle="tooltip" title="Due on date">
                      <i class="fas fa-hourglass-half me-2 text-warning"></i>
                    </a>
                      {{item.due_date}}
                  </p>
                </div>
              </li>
              <li class="list-group-item ps-3 pe-0 py-1 rounded-0 border-0 bg-transparent">
                <div class="d-flex flex-row justify-content-end mb-1">
                  <a href="#!" class="text-danger" data-mdb-toggle="tooltip" title="Delete todo" onclick="deleteTask('{{item.id}}')"><i
                      class="fas fa-trash-alt"></i></a>
                </div>
                <div class="text-end text-muted">
                    <p class="small mb-0 text-muted"><i class="fas fa-info-circle me-2" data-mdb-toggle="tooltip" title="Created"></i>{{item.creation_date}}</p>
                </div>
              </li>
            </ul>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Your existing HTML code -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const todoItemForm = document.getElementById("TodoItemForm");
    const addTaskButton = document.getElementById("addTaskButton");

    addTaskButton.addEventListener("click", function () {

        const formData = new FormData(todoItemForm);

        fetch(todoItemForm.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
            },
        })
        .then(response => response.json())
        .then(data => {

            if (data.success) {
                // Clear the form
                todoItemForm.reset();

                // Reload the page
                location.reload();
            } else {
                // Handle errors if needed
                console.error("Error:", data.errors);
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });
});

</script>
<script>
function deleteTask(taskId) {
  if (confirm("Are you sure you want to delete this task?")) {
    fetch(`{% url 'delete_todo' pk=0 %}`.replace('0', taskId), {  // Replace '0' with a placeholder
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Response data:", data);
      if (data && data.success) {
        // Reload the page after successful deletion
        location.reload();
      } else {
        console.error("Error:", data ? data.error : "No response error");
      }
    })
    .catch(error => {
      console.error("Error:", error);
    });
  }
}


</script>




{% endblock %}
